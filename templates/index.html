<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêù Bee360 - Disparador de Campanhas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .disabled-input { background-color: #e5e7eb; cursor: not-allowed; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
<div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow-md">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <img src="https://s3.archanjo.co/chatwoot/PNG%20Bee%20High%20resolution%20%28square%29.png" class="w-8 h-8"> Bee360 - Disparador
    </h1>
    <button id="logoutBtn" class="text-sm text-red-500">Sair</button>
  </div>
  <hr class="my-4">

  <form id="loginForm" class="mb-4 hidden">
    <label class="block mb-2">Chave de Acesso:</label>
    <input id="authToken" class="w-full border p-2 rounded" type="password" required>
    <button type="submit" class="mt-2 bg-yellow-400 text-black px-4 py-2 rounded">Entrar</button>
  </form>

  <div id="mainApp" class="space-y-6 hidden">
    <section>
      <h2 class="text-lg font-semibold">Configura√ß√£o da Campanha</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
        <select id="accountCombo" class="border p-2 rounded"></select>
        <select id="inboxCombo" class="border p-2 rounded"></select>
        <input id="campaignName" type="text" placeholder="Nome da Campanha" class="border p-2 rounded">
      </div>
    </section>

    <section>
      <h2 class="text-lg font-semibold">Segmenta√ß√£o</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
        <select id="triggerType" class="border p-2 rounded">
          <option value="etiquetas">Disparo por Etiqueta</option>
          <option value="csv">Importar via CSV</option>
          <option value="custom_fields">Disparo por Campos Personalizados</option>
          <option value="no_conversations">Contatos Sem Conversa</option>
          <option value="no_interaction">Mais Tempo Sem Intera√ß√£o</option>
        </select>
        <input id="quantity" type="number" placeholder="Qtd. de contatos" class="border p-2 rounded">
        <select id="labelCombo" class="border p-2 rounded"></select>
        <input id="csvFile" type="file" class="border p-2 rounded" accept=".csv">
        <input id="scheduledTime" type="datetime-local" class="border p-2 rounded">
      </div>
    </section>

    <section>
      <h2 class="text-lg font-semibold">Mensagem</h2>
      <textarea id="messageInput" rows="4" placeholder="Ol√° {nome}, tudo bem?" class="w-full border p-2 rounded"></textarea>
      <input id="fileInput" type="file" class="mt-2 border p-2 rounded">
    </section>

    <section class="text-center flex flex-wrap gap-2 justify-center">
      <button onclick="previewCampaign()" class="bg-blue-200 hover:bg-blue-100 text-black font-semibold px-4 py-2 rounded">Pr√©via da Campanha</button>
      <button onclick="startCampaign()" class="bg-yellow-400 hover:bg-yellow-300 text-black font-semibold px-4 py-2 rounded">Iniciar Disparo</button>
      <button onclick="repeatCampaign()" class="bg-purple-300 hover:bg-purple-200 text-black font-semibold px-4 py-2 rounded">Repetir √öltima Campanha</button>
      <button onclick="clearCampaign()" class="bg-red-300 hover:bg-red-200 text-black font-semibold px-4 py-2 rounded">Limpar Tudo</button>
    </section>

    <p id="statusMsg" class="text-center text-sm text-gray-500 mt-2"></p>

    <section>
      <h2 class="text-lg font-semibold">Logs e Relat√≥rios</h2>
      <div id="logContainer" class="bg-gray-50 border rounded p-4 h-40 overflow-y-auto text-sm text-gray-700"></div>
    </section>
  </div>
</div>


<div class="mt-6 text-center">
    <button onclick="verHistorico()" class="bg-gray-200 hover:bg-gray-100 px-4 py-2 rounded">üìä Ver Hist√≥rico</button>
  </div>
  
  <div id="historyBox" class="mt-4 overflow-auto text-sm text-left bg-white border rounded p-4 shadow-inner max-h-96"></div>
  

<script>
const authKey = "Bee360Secret123";
let contacts = [], attachmentId = null, lastPayload = null;

window.onload = () => {
  document.getElementById('loginForm').classList.remove("hidden");
  document.getElementById("loginForm").onsubmit = e => {
    e.preventDefault();
    const token = document.getElementById("authToken").value;
    if (token === authKey) {
      document.getElementById('loginForm').classList.add("hidden");
      document.getElementById('mainApp').classList.remove("hidden");
      loadInitialData();
    } else {
      alert("Chave de acesso incorreta!");
    }
  };
  document.getElementById("logoutBtn").onclick = () => location.reload();
}




function verHistorico() {
    fetch('/api/campaigns/history/table')
      .then(res => res.text())
      .then(html => {
        document.getElementById('historyBox').innerHTML = html;
      });
  }




function loadInitialData() {
  fetch("/api/accounts").then(r => r.json()).then(data => {
    const combo = document.getElementById("accountCombo");
    combo.innerHTML = data.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join("");
    loadInboxes(); loadLabels();
  });
}

function loadInboxes() {
  const id = document.getElementById("accountCombo").value;
  fetch(`/api/inboxes/${id}`).then(r => r.json()).then(data => {
    const combo = document.getElementById("inboxCombo");
    combo.innerHTML = data.map(i => `<option value="${i.id}">${i.name}</option>`).join("");
  });
}

function loadLabels() {
  const id = document.getElementById("accountCombo").value;
  fetch(`/api/labels/${id}`).then(r => r.json()).then(data => {
    const combo = document.getElementById("labelCombo");
    combo.innerHTML = data.map(i => `<option value="${i.title}">${i.title}</option>`).join("");
  });
}

function previewCampaign() {
  const name = document.getElementById("campaignName").value;
  const trigger = document.getElementById("triggerType").value;
  const label = document.getElementById("labelCombo").value;
  const qtd = document.getElementById("quantity").value;
  const msg = document.getElementById("messageInput").value;
  alert(`Campanha: ${name}\nTipo: ${trigger}\nEtiqueta: ${label}\nQtd: ${qtd || 'Todos'}\nMensagem: ${msg}`);
}

async function startCampaign() {
  const statusMsg = document.getElementById("statusMsg");
  statusMsg.textContent = "Processando...";
  const accountId = document.getElementById("accountCombo").value;
  const inboxId = document.getElementById("inboxCombo").value;
  const label = document.getElementById("labelCombo").value;
  const message = document.getElementById("messageInput").value;
  const quantity = document.getElementById("quantity").value || "Todos";
  const trigger = document.getElementById("triggerType").value;
  const time = document.getElementById("scheduledTime").value;
  const file = document.getElementById("fileInput").files[0];

  let attachment_id = null;
  if (file) {
    const fd = new FormData(); fd.append("attachment", file); fd.append("account_id", accountId);
    const res = await fetch("/api/upload_attachment", { method: "POST", body: fd });
    const json = await res.json(); if (json.attachment_id) attachment_id = json.attachment_id;
  }

  let payload = {
    account_id: accountId,
    inbox_id: inboxId,
    message,
    quantity,
    attachment_id,
    label
  };

  if (trigger === "csv") {
    const csv = document.getElementById("csvFile").files[0];
    if (!csv) return alert("Selecione um CSV");
    const fd = new FormData(); fd.append("csvFile", csv);
    const res = await fetch("/api/upload_csv", { method: "POST", body: fd });
    const json = await res.json();
    if (json.contacts) payload.contacts = json.contacts;
  }

  lastPayload = payload;

  if (time) {
    statusMsg.textContent = `Campanha agendada para ${new Date(time).toLocaleString()}`;
    return setTimeout(() => sendNow(payload), new Date(time) - new Date());
  }

  sendNow(payload);
}

function sendNow(payload) {
  fetch("/api/start_campaign", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(data => {
    document.getElementById("statusMsg").textContent = data.message;
    document.getElementById("logContainer").innerHTML += `<div>${new Date().toLocaleString()} - ${data.message}</div>`;
  });
}

function clearCampaign() {
  document.getElementById("messageInput").value = "";
  document.getElementById("fileInput").value = "";
  document.getElementById("csvFile").value = "";
  document.getElementById("campaignName").value = "";
  document.getElementById("scheduledTime").value = "";
  document.getElementById("quantity").value = "";
  document.getElementById("statusMsg").textContent = "";
  contacts = []; attachmentId = null; lastPayload = null;
}

function repeatCampaign() {
  if (!lastPayload) return alert("Nenhuma campanha anterior encontrada.");
  sendNow(lastPayload);
}
</script>
</body>
</html>
