<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêù Bee360 - Disparador</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-4xl mx-auto py-8 px-4">
    <h1 class="text-3xl font-bold mb-6">üêù Bee360 - Disparador</h1>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Nome da Conta:</label>
      <div id="accountName" class="bg-gray-200 p-2 rounded">Carregando...</div>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Telefone (Inbox):</label>
      <select id="inboxCombo" class="w-full p-2 border rounded"></select>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Nome da Campanha:</label>
      <input id="campaignName" type="text" class="w-full p-2 border rounded" placeholder="Digite o nome da campanha">
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Tipo de Disparo:</label>
      <select id="triggerType" class="w-full p-2 border rounded">
        <option value="etiquetas">Disparo por Etiqueta</option>
        <option value="csv">Importar CSV</option>
      </select>
    </div>

    <div id="etiquetasGroup" class="mb-4">
      <label class="block mb-1 font-semibold">Etiqueta:</label>
      <select id="labelCombo" class="w-full p-2 border rounded"></select>
    </div>

    <div id="csvGroup" class="mb-4 hidden">
      <label class="block mb-1 font-semibold">CSV com colunas nome/telefone:</label>
      <input id="csvFile" type="file" class="w-full">
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Qtd. de contatos:</label>
      <input id="quantityInput" type="number" class="w-full p-2 border rounded" placeholder="Todos">
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Mensagem:</label>
      <textarea id="messageInput" class="w-full p-2 border rounded" rows="4" placeholder="Ol√° {nome}, tudo bem?"></textarea>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Anexo (opcional):</label>
      <input id="fileInput" type="file" class="w-full">
    </div>

    <div class="flex flex-wrap gap-2 mb-6">
      <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="previewCampaign()">Pr√©via da Campanha</button>
      <button class="bg-yellow-400 text-black px-4 py-2 rounded" onclick="startCampaign()">Iniciar Disparo</button>
      <button class="bg-pink-500 text-white px-4 py-2 rounded" onclick="repeatCampaign()">Repetir √öltima Campanha</button>
      <button class="bg-red-400 text-white px-4 py-2 rounded" onclick="clearForm()">Limpar Tudo</button>
    </div>

    <div>
      <h2 class="text-xl font-bold mb-2">Logs e Relat√≥rios</h2>
      <div id="logContainer" class="bg-white border rounded p-4"></div>
    </div>
  </div>

  <script>
    const ACCOUNT_ID = 58;

    window.onload = () => {
      fetch(`/api/account_name`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("accountName").textContent = data.name || `Conta ${ACCOUNT_ID}`;
        });

      fetch(`/api/inboxes`)
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("inboxCombo");
          data.forEach(inbox => {
            const opt = document.createElement("option");
            opt.value = inbox.id;
            opt.textContent = inbox.name;
            select.appendChild(opt);
          });
        });

      fetch(`/api/labels`)
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("labelCombo");
          data.forEach(label => {
            const opt = document.createElement("option");
            opt.value = label.title;
            opt.textContent = label.title;
            select.appendChild(opt);
          });
        });

      fetch("/api/campaigns/history/table")
        .then(res => res.text())
        .then(html => document.getElementById("logContainer").innerHTML = html);

      document.getElementById("triggerType").addEventListener("change", (e) => {
        document.getElementById("etiquetasGroup").classList.toggle("hidden", e.target.value !== "etiquetas");
        document.getElementById("csvGroup").classList.toggle("hidden", e.target.value !== "csv");
      });
    };

    function previewCampaign() {
      const msg = document.getElementById("messageInput").value;
      alert("Pr√©via:\n" + msg);
    }

    function startCampaign() {
      const inbox_id = document.getElementById("inboxCombo").value;
      const campaign_name = document.getElementById("campaignName").value;
      const message = document.getElementById("messageInput").value;
      const quantity = document.getElementById("quantityInput").value || "Todos";
      const triggerType = document.getElementById("triggerType").value;
      const label = document.getElementById("labelCombo").value;
      const attachmentFile = document.getElementById("fileInput").files[0];
      const csvFile = document.getElementById("csvFile").files[0];

      const payload = {
        account_id: ACCOUNT_ID,
        inbox_id,
        campaign_name,
        message,
        quantity,
        trigger_type: triggerType,
        label
      };

      if (triggerType === "csv" && csvFile) {
        const formData = new FormData();
        formData.append("csvFile", csvFile);
        fetch("/api/upload_csv", { method: "POST", body: formData })
          .then(res => res.json())
          .then(data => {
            payload.contacts = data.contacts;
            handleAttachmentAndSend(payload, attachmentFile);
          });
      } else {
        handleAttachmentAndSend(payload, attachmentFile);
      }
    }

    function handleAttachmentAndSend(payload, file) {
      if (file) {
        const formData = new FormData();
        formData.append("attachment", file);
        fetch("/api/upload_attachment", {
          method: "POST",
          body: formData
        })
          .then(res => res.json())
          .then(data => {
            payload.attachment_id = data.attachment_id;
            sendPayload(payload);
          });
      } else {
        sendPayload(payload);
      }
    }

    function sendPayload(payload) {
      fetch("/api/start_campaign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(data => alert(data.message));
    }

    function repeatCampaign() {
      alert("Fun√ß√£o de repetir campanha ainda n√£o implementada.");
    }

    function clearForm() {
      document.getElementById("campaignName").value = "";
      document.getElementById("messageInput").value = "";
      document.getElementById("quantityInput").value = "";
      document.getElementById("fileInput").value = "";
      document.getElementById("csvFile").value = "";
    }
  </script>
</body>
</html>
