<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Bee360 - Disparador</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">üêù Bee360 - Disparador</h1>

        <div class="mb-4">
            <label class="font-semibold">Conta:</label>
            <div id="accountName" class="bg-gray-200 p-2 rounded"></div>
        </div>

        <div class="mb-4">
            <label class="font-semibold">Inbox (Telefone):</label>
            <select id="inboxSelect" class="w-full p-2 border rounded"></select>
        </div>

        <div class="mb-4">
            <label class="font-semibold">Nome da Campanha:</label>
            <input id="campaignName" class="w-full p-2 border rounded" placeholder="Campanha X">
        </div>

        <div class="mb-4">
            <label class="font-semibold">Tipo de Disparo:</label>
            <select id="triggerType" class="w-full p-2 border rounded">
                <option value="etiquetas">Por Etiqueta</option>
                <option value="csv">Importar CSV</option>
            </select>
        </div>

        <div class="mb-4" id="labelGroup">
            <label class="font-semibold">Etiqueta:</label>
            <select id="labelSelect" class="w-full p-2 border rounded"></select>
        </div>

        <div class="mb-4 hidden" id="csvGroup">
            <label class="font-semibold">CSV:</label>
            <input type="file" id="csvFile" class="w-full">
        </div>

        <div class="mb-4">
            <label class="font-semibold">Quantidade de Contatos:</label>
            <input id="quantityInput" class="w-full p-2 border rounded" placeholder="Todos">
        </div>

        <div class="mb-4">
            <label class="font-semibold">Mensagem:</label>
            <textarea id="messageInput" class="w-full p-2 border rounded" placeholder="Ol√° {nome}, tudo bem?"></textarea>
        </div>

        <div class="flex gap-2">
            <button onclick="startCampaign()" class="bg-green-500 text-white px-4 py-2 rounded">Disparar</button>
            <button onclick="clearForm()" class="bg-gray-400 text-white px-4 py-2 rounded">Limpar</button>
        </div>

        <div class="mt-10">
            <h2 class="text-xl font-bold mb-2">Hist√≥rico</h2>
            <div id="logContainer" class="bg-white p-4 border rounded"></div>
        </div>
    </div>

    <script>
        const ACCOUNT_ID = 58;

        window.onload = () => {
            fetch('/api/account_data')
                .then(res => res.json())
                .then(data => {
                    document.getElementById("accountName").textContent = data.nome;

                    const inboxSelect = document.getElementById("inboxSelect");
                    data.inboxes.forEach(inbox => {
                        const opt = document.createElement("option");
                        opt.value = inbox.id;
                        opt.text = inbox.name;
                        inboxSelect.appendChild(opt);
                    });

                    const labelSelect = document.getElementById("labelSelect");
                    data.etiquetas.forEach(label => {
                        const opt = document.createElement("option");
                        opt.value = label;
                        opt.text = label;
                        labelSelect.appendChild(opt);
                    });
                });

            fetch("/api/campaigns/history/table")
                .then(res => res.text())
                .then(html => document.getElementById("logContainer").innerHTML = html);

            document.getElementById("triggerType").addEventListener("change", (e) => {
                const isCSV = e.target.value === "csv";
                document.getElementById("labelGroup").classList.toggle("hidden", isCSV);
                document.getElementById("csvGroup").classList.toggle("hidden", !isCSV);
            });
        };

        function startCampaign() {
            const inbox_id = document.getElementById("inboxSelect").value;
            const campaign_name = document.getElementById("campaignName").value;
            const message = document.getElementById("messageInput").value;
            const quantity = document.getElementById("quantityInput").value || "Todos";
            const triggerType = document.getElementById("triggerType").value;
            const label = document.getElementById("labelSelect").value;
            const csvFile = document.getElementById("csvFile").files[0];

            const payload = {
                inbox_id,
                campaign_name,
                message,
                quantity,
                trigger_type: triggerType,
                label
            };

            if (triggerType === "csv" && csvFile) {
                const formData = new FormData();
                formData.append("csvFile", csvFile);
                fetch("/api/upload_csv", {
                    method: "POST",
                    body: formData
                }).then(res => res.json())
                  .then(data => {
                    payload.contacts = data.contacts;
                    sendNow(payload);
                });
            } else {
                sendNow(payload);
            }
        }

        function sendNow(payload) {
            fetch("/api/start_campaign", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(res => res.json()).then(data => alert(data.message));
        }

        function clearForm() {
            document.getElementById("campaignName").value = "";
            document.getElementById("messageInput").value = "";
            document.getElementById("quantityInput").value = "";
            document.getElementById("csvFile").value = "";
        }
    </script>
</body>
</html>
